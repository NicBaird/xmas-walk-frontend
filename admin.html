<!DOCTYPE html>
<html>
<head><title>Xmas Walk Admin</title></head>
<body>

<h2>Update Xmas Walk</h2>

<select id="currentSelect"></select>
<select id="nextSelect"></select>

<select id="statusSelect">
  <option value="In Transit">In Transit</option>
  <option value="At Location">At Location</option>
  <option value="Leaving">Leaving</option>
</select>

<input id="stopNumber" type="number" min="1">

<h3>Custom Current Location</h3>
<div id="customCurrent" style="display:none">
  <input id="currentCustomName" placeholder="Name">
  <input id="currentCustomAddress" placeholder="Address">
  <textarea id="currentCustomDescription" placeholder="Description"></textarea>
  <input id="currentCustomImage" placeholder="Image URL">
</div>

<h3>Custom Next Location</h3>
<div id="customNext" style="display:none">
  <input id="nextCustomName" placeholder="Name">
  <input id="nextCustomAddress" placeholder="Address">
  <textarea id="nextCustomDescription" placeholder="Description"></textarea>
  <input id="nextCustomImage" placeholder="Image URL">
</div>



<input id="k" type="password" placeholder="Admin Key"><br><br>

<button onclick="update()">Update</button>

<script>
const API = "https://xmas-walk-backend.onrender.com";

let locations = [];

async function loadLocations() {
    try {
        const res = await fetch(API + "/state");
        const data = await res.json();

        locations = data.locations || [];

        fillSelect(currentSelect);
        fillSelect(nextSelect);

        // Optional: pre-select current & next
        if (data.state) {
            if (data.state.current !== null) {
            currentSelect.value = data.state.current;
            }
            if (data.state.next !== null) {
            nextSelect.value = data.state.next;
            }
            if (data.state.status) {
            statusSelect.value = data.state.status;
            }
            if (data.state.stopNumber) {
            stopNumber.value = data.state.stopNumber;
            }
        }
        // Restore current custom
            if (data.state.current === null && data.state.currentCustom) {
            currentSelect.value = "CUSTOM";
            toggleCustomFields();

            currentCustomName.value = data.state.currentCustom.name || "";
            currentCustomAddress.value = data.state.currentCustom.address || "";
            currentCustomDescription.value = data.state.currentCustom.description || "";
            currentCustomImage.value = data.state.currentCustom.image || "";
            }

            // Restore next custom
            if (data.state.next === null && data.state.nextCustom) {
            nextSelect.value = "CUSTOM";
            toggleCustomFields();

            nextCustomName.value = data.state.nextCustom.name || "";
            nextCustomAddress.value = data.state.nextCustom.address || "";
            nextCustomDescription.value = data.state.nextCustom.description || "";
            nextCustomImage.value = data.state.nextCustom.image || "";
            }
            toggleCustomFields();
    } catch (err) {
        alert("Backend unavailable. Using cached UI only.")
    }
}

// Populate dropdowns
function fillSelect(select) {
  select.innerHTML = "";

  locations.forEach((loc, i) => {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = loc.name;
    select.appendChild(option);
  });

  const customOption = document.createElement("option");
  customOption.value = "CUSTOM";
  customOption.textContent = "CUSTOM";
  select.appendChild(customOption);
}


loadLocations();


// Show/hide custom fields
function toggleCustomFields() {
  customCurrent.style.display =
    currentSelect.value === "CUSTOM" ? "block" : "none";

  customNext.style.display =
    nextSelect.value === "CUSTOM" ? "block" : "none";
}

currentSelect.addEventListener("change", toggleCustomFields);
nextSelect.addEventListener("change", toggleCustomFields);


// Update function
async function update() {
  const usingCurrentCustom = currentSelect.value === "CUSTOM";
  const usingNextCustom = nextSelect.value === "CUSTOM";

  const payload = {
    status: statusSelect.value,
    stopNumber: parseInt(stopNumber.value),
    current: usingCurrentCustom ? null : parseInt(currentSelect.value),
    next: usingNextCustom ? null : parseInt(nextSelect.value),
    currentCustom: null,
    nextCustom: null
  };

  if (usingCurrentCustom) {
    payload.currentCustom = {
      name: currentCustomName.value,
      address: currentCustomAddress.value,
      description: currentCustomDescription.value,
      image: currentCustomImage.value
    };
  }

  if (usingNextCustom) {
    payload.nextCustom = {
      name: nextCustomName.value,
      address: nextCustomAddress.value,
      description: nextCustomDescription.value,
      image: nextCustomImage.value
    };
  }

  const res = await fetch(API + "/update?key=" + k.value, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  localStorage.setItem("xmas-walk-force-refresh", Date.now().toString());
  alert("Updated!");
}

</script>


</body>
</html>
