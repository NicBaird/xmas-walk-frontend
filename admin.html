<!DOCTYPE html>
<html>
<head><title>Xmas Walk Admin</title></head>
<body>

<h2>Update Xmas Walk</h2>

<select id="currentSelect"></select>
<select id="nextSelect"></select>

<select id="statusSelect">
  <option value="In Transit">In Transit</option>
  <option value="At Location">At Location</option>
  <option value="Leaving">Leaving</option>
</select>

<input id="stopNumber" type="number" min="1">

<div id="customFields" style="display:none">
  <input id="customName" placeholder="Name">
  <input id="customAddress" placeholder="Address">
  <textarea id="customDescription" placeholder="Description"></textarea>
  <input id="customImage" placeholder="Image URL">
</div>



<input id="k" type="password" placeholder="Admin Key"><br><br>

<button onclick="update()">Update</button>

<script>
const API = "https://xmas-walk-backend.onrender.com";

let locations = [];

async function loadLocations() {
  const res = await fetch(API + "/state");
  const data = await res.json();

  locations = data.locations || [];

  fillSelect(currentSelect);
  fillSelect(nextSelect);

  // Optional: pre-select current & next
  if (data.state) {
    if (data.state.current !== null) {
      currentSelect.value = data.state.current;
    }
    if (data.state.next !== null) {
      nextSelect.value = data.state.next;
    }
    if (data.state.status) {
      statusSelect.value = data.state.status;
    }
    if (data.state.stopNumber) {
      stopNumber.value = data.state.stopNumber;
    }
  }
}

// Populate dropdowns
function fillSelect(select) {
  select.innerHTML = "";

  locations.forEach((loc, i) => {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = loc.name;
    select.appendChild(option);
  });

  const customOption = document.createElement("option");
  customOption.value = "CUSTOM";
  customOption.textContent = "CUSTOM";
  select.appendChild(customOption);
}


loadLocations();


// Show/hide custom fields
function toggleCustomFields() {
  if (currentSelect.value === "CUSTOM" || nextSelect.value === "CUSTOM") {
    customFields.style.display = "block";
  } else {
    customFields.style.display = "none";
  }
}

currentSelect.addEventListener("change", toggleCustomFields);
nextSelect.addEventListener("change", toggleCustomFields);

// Update function
async function update() {
  const payload = {
    status: statusSelect.value,
    stopNumber: parseInt(stopNumber.value),
    current: currentSelect.value === "CUSTOM" ? null : parseInt(currentSelect.value),
    next: nextSelect.value === "CUSTOM" ? null : parseInt(nextSelect.value),
    custom: null
  };

  if (currentSelect.value === "CUSTOM" || nextSelect.value === "CUSTOM") {
    payload.custom = {
      name: customName.value,
      address: customAddress.value,
      description: customDescription.value,
      image: customImage.value
    };
  }

  const key = k.value;
  try {
    const res = await fetch(`${API}/update?key=${key}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    alert(JSON.stringify(data));
  } catch (err) {
    alert("Error updating: " + err);
  }
}
</script>


</body>
</html>
